<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Redis入门指南（第2版）</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<blockquote id="filepos579889" class="calibre_11"><a href="index_split_000.html#filepos28438"><span class="calibre2"><span class="bold"><span class="calibre_2">9.2 通信协议</span></span></span></a></blockquote><p class="calibre_14">Redis通信协议是Redis客户端与Redis之间交流的语言，通信协议规定了命令和返回值的格式。了解Redis通信协议后不仅可以理解AOF文件的格式和主从复制时主数据库向从数据库发送的内容等，还可以开发自己的 Redis 客户端（不过由于几乎所有常用的语言都有相应的Redis客户端，需要使用通信协议直接和Redis打交道的机会确实不多）。</p><p class="calibre_9">Redis支持两种通信协议，一种是二进制安全的统一请求协议（unified request protocol），另一种是比较直观的便于在 telnet 程序中输入的简单协议。这两种协议只是命令的格式有区别，命令返回值的格式是一样的。</p><p id="filepos580848" class="calibre_6"><a href="index_split_000.html#filepos28631"><span class="calibre6"><span class="bold"><span class="calibre_2">9.2.1 简单协议</span></span></span></a></p><p class="calibre_14">简单协议适合在telnet程序中和Redis通信。简单协议的命令格式就是将命令和各个参数使用空格分隔开，如“EXISTS foo”、“SET foo bar”等。由于 Redis 解析简单协议时只是简单地以空格分隔参数，所以无法输入二进制字符。我们可以通过telnet程序测试：</p><p class="calibre_9">$ telnet 127.0.0.1 6379</p><p class="calibre_9">Trying 127.0.0.1...</p><p class="calibre_9">Connected to localhost.</p><p class="calibre_9">Escape character is '^]'.</p><p class="calibre_9">SET foo bar</p><p class="calibre_9">+OK</p><p class="calibre_9">GET foo</p><p class="calibre_9">$3</p><p class="calibre_9">bar</p><p class="calibre_9">LPUSH plist 1 2 3</p><p class="calibre_9">:3</p><p class="calibre_9">LRANGE plist 0 -1</p><p class="calibre_9">*3</p><p class="calibre_9">$1</p><p class="calibre_9">3</p><p class="calibre_9">$1</p><p class="calibre_9">2</p><p class="calibre_9">$1</p><p class="calibre_9">1</p><p class="calibre_9">ERRORCOMMAND</p><p class="calibre_9">-ERR unknown command 'ERRORCOMMAND'</p><p class="calibre_9">提示 Redis 2.4 前的版本对于某些命令可以使用类似简单协议的特殊方式输入二进制安全的参数，例如：</p><p class="calibre_9">C: SET foo 3</p><p class="calibre_9">C: bar</p><p class="calibre_9">S: +OK</p><p class="calibre_9">其中C:表示客户端发出的内容，S:表示服务端发出的内容。第一行的最后一个参数表示字符串的长度，第二行是字符串的实际内容，因为指定了长度，所以第二行的字符串可以包含二进制字符。但是这个协议已经废弃，被新的统一请求协议取代。“统一”二字指的所有的命令使用同样的请求方式而不再为某些命令使用特殊方式，如果需要在参数中包含二进制字符应该使用9.2.2节介绍的统一请求协议。</p><p class="calibre_9">我们在telnet程序中输入的5条命令恰好展示了Redis的5种返回值类型的格式，2.3.2节介绍了这5种返回值类型在redis-cli中的展现形式，这些展现形式是经过了redis-cli封装的，而上面的内容才是Redis真正返回的格式。下面分别介绍。</p><p class="calibre_9">1．错误回复</p><p class="calibre_9">错误回复（error reply）以-开头，并在后面跟上错误信息，最后以\r\n 结尾：</p><p class="calibre_9">-ERR unknown command 'ERRORCOMMAND'\r\n</p><p class="calibre_9">2．状态回复</p><p class="calibre_9">状态回复（status reply）以+开头，并在后面跟上状态信息，最后以\r\n 结尾：</p><p class="calibre_9">+OK\r\n</p><p class="calibre_9">3．整数回复</p><p class="calibre_9">整数回复（integer reply）以:开头，并在后面跟上数字，最后以\r\n 结尾：</p><p class="calibre_9">:3\r\n</p><p class="calibre_9">4．字符串回复</p><p class="calibre_9">字符串回复（bulk reply）以$开头，并在后面跟上字符串的长度，并以\r\n 分隔，接着是字符串的内容和\r\n：</p><p class="calibre_9">$3\r\nbar\r\n</p><p class="calibre_9">如果返回值是空结果nil，则会返回$-1以和空字符串相区别。</p><p class="calibre_9">5．多行字符串回复</p><p class="calibre_9">多行字符串回复（multi-bulk reply）以*开头，并在后面跟上字符串回复的组数，并以\r\n分隔。接着后面跟的就是字符串回复的具体内容了：</p><p class="calibre_9">*3\r\n$1\r\n3\r\n$1\r\n2\r\n$1\r\n1\r\n</p><p id="filepos585376" class="calibre_6"><a href="index_split_000.html#filepos28830"><span class="calibre6"><span class="bold"><span class="calibre_2">9.2.2 统一请求协议</span></span></span></a></p><p class="calibre_14">统一请求协议是从 Redis 1.2 开始加入的，其命令格式和多行字符串回复的格式很类似，如 SET foo bar的统一请求协议写法是*3\r\n$3\r\nSET\r\n$3\r\nfoo\r\n$3 \r\nbar\r\n。还是使用telnet进行演示：</p><p class="calibre_9">$ telnet 127.0.0.1 6379</p><p class="calibre_9">Trying 127.0.0.1...</p><p class="calibre_9">Connected to localhost.</p><p class="calibre_9">Escape character is '^]'.</p><p class="calibre_9">*3</p><p class="calibre_9">$3</p><p class="calibre_9">SET</p><p class="calibre_9">$3</p><p class="calibre_9">foo</p><p class="calibre_9">$3</p><p class="calibre_9">bar</p><p class="calibre_9">+OK</p><p class="calibre_9">同样发送命令时指定了后面字符串的长度，所以命令的每个参数都可以包含二进制的字符。统一请求协议的返回值格式和简单协议一样，这里不再赘述。</p><p class="calibre_9">Redis的AOF文件和主从复制时主数据库向从数据库发送的内容都使用了统一请求协议。如果要开发一个和Redis直接通信的客户端，推荐使用此协议。如果只是想通过telnet向Redis服务器发送命令则使用简单协议就可以了。</p><div class="mbp_pagebreak" id="calibre_pb_46"></div>
</body></html>
