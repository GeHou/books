<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Redis入门指南（第2版）</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<blockquote id="filepos480206" class="calibre_11"><a href="index_split_000.html#filepos23074"><span class="calibre2"><span class="bold"><span class="calibre_2">7.2 AOF方式</span></span></span></a></blockquote><p class="calibre_14">当使用Redis存储非临时数据时，一般需要打开AOF持久化来降低进程中止导致的数据丢失。AOF可以将Redis执行的每一条写命令追加到硬盘文件中，这一过程显然会降低Redis 的性能，但是大部分情况下这个影响是可以接受的，另外使用较快的硬盘可以提高AOF的性能。</p><p id="filepos480753" class="calibre_6"><a href="index_split_000.html#filepos23264"><span class="calibre6"><span class="bold"><span class="calibre_2">7.2.1 开启AOF</span></span></span></a></p><p class="calibre_14">默认情况下Redis没有开启AOF（append only file）方式的持久化，可以通过 appendonly参数启用：</p><p class="calibre_9">appendonly yes</p><p class="calibre_9">开启AOF持久化后每执行一条会更改Redis中的数据的命令，Redis就会将该命令写入硬盘中的AOF文件。AOF文件的保存位置和RDB文件的位置相同，都是通过dir参数设置的，默认的文件名是appendonly.aof，可以通过appendfilename参数修改：</p><p class="calibre_9">appendfilename appendonly.aof</p><p id="filepos481528" class="calibre_6"><a href="index_split_000.html#filepos23457"><span class="calibre6"><span class="bold"><span class="calibre_2">7.2.2 AOF的实现</span></span></span></a></p><p class="calibre_14">AOF文件以纯文本的形式记录了Redis执行的写命令，例如在开启AOF持久化的情况下执行了如下4个命令：</p><p class="calibre_9">SET foo 1</p><p class="calibre_9">SET foo 2</p><p class="calibre_9">SET foo 3</p><p class="calibre_9">GET foo</p><p class="calibre_9">Redis会将前3条命令写入AOF文件中，此时AOF文件中的内容如下：</p><p class="calibre_9">*2</p><p class="calibre_9">$6</p><p class="calibre_9">SELECT</p><p class="calibre_9">$1</p><p class="calibre_9">0</p><p class="calibre_9">*3</p><p class="calibre_9">$3</p><p class="calibre_9">set</p><p class="calibre_9">$3</p><p class="calibre_9">foo</p><p class="calibre_9">$1</p><p class="calibre_9">1</p><p class="calibre_9">*3</p><p class="calibre_9">$3</p><p class="calibre_9">set</p><p class="calibre_9">$3</p><p class="calibre_9">foo</p><p class="calibre_9">$1</p><p class="calibre_9">2</p><p class="calibre_9">*3</p><p class="calibre_9">$3</p><p class="calibre_9">set</p><p class="calibre_9">$3</p><p class="calibre_9">foo</p><p class="calibre_9">$1</p><p class="calibre_9">3</p><p class="calibre_9">可见 AOF文件的内容正是 Redis 客户端向 Redis 发送的原始通信协议的内容（Redis的通信协议会在9.2节中介绍，为了便于阅读，这里将实际的命令部分以粗体显示），从中可见Redis确实只记录了前3条命令。然而这时有一个问题是前2条命令其实都是冗余的，因为这两条的执行结果会被第三条命令覆盖。随着执行的命令越来越多，AOF文件的大小也会越来越大，即使内存中实际的数据可能并没有多少。很自然地，我们希望 Redis 可以自动优化AOF文件，就上例而言，就是将前两条无用的记录删除，只保留第三条。实际上Redis也正是这样做的，每当达到一定条件时Redis就会自动重写AOF文件，这个条件可以在配置文件中设置：</p><p class="calibre_9">auto-aof-rewrite-percentage 100</p><p class="calibre_9">auto-aof-rewrite-min-size 64mb</p><p class="calibre_9">auto-aof-rewrite-percentage参数的意义是当目前的AOF文件大小超过上一次重写时的AOF文件大小的百分之多少时会再次进行重写，如果之前没有重写过，则以启动时的AOF文件大小为依据。auto-aof-rewrite-min-size参数限制了允许重写的最小AOF文件大小，通常在AOF文件很小的情况下即使其中有很多冗余的命令我们也并不太关心。除了让Redis自动执行重写外，我们还可以主动使用BGREWRITEAOF命令手动执行AOF重写。</p><p class="calibre_9">上例中的AOF文件重写后的内容为：</p><p class="calibre_9">*2</p><p class="calibre_9">$6</p><p class="calibre_9">SELECT</p><p class="calibre_9">$1</p><p class="calibre_9">0</p><p class="calibre_9">*3</p><p class="calibre_9">$3</p><p class="calibre_9">SET</p><p class="calibre_9">$3</p><p class="calibre_9">foo</p><p class="calibre_9">$1</p><p class="calibre_9">3</p><p class="calibre_9">可见冗余的命令已经被删除了。重写的过程只和内存中的数据有关，和之前的 AOF文件无关，这与RDB很相似，只不过二者的文件格式完全不同。</p><p class="calibre_9">在启动时Redis会逐个执行AOF文件中的命令来将硬盘中的数据载入到内存中，载入的速度相较RDB会慢一些。</p><p id="filepos486060" class="calibre_6"><a href="index_split_000.html#filepos23656"><span class="calibre6"><span class="bold"><span class="calibre_2">7.2.3 同步硬盘数据</span></span></span></a></p><p class="calibre_14">虽然每次执行更改数据库内容的操作时，AOF都会将命令记录在AOF文件中，但是事实上，由于操作系统的缓存机制，数据并没有真正地写入硬盘，而是进入了系统的硬盘缓存。在默认情况下系统每30秒会执行一次同步操作，以便将硬盘缓存中的内容真正地写入硬盘，在这30秒的过程中如果系统异常退出则会导致硬盘缓存中的数据丢失。一般来讲启用AOF持久化的应用都无法容忍这样的损失，这就需要Redis在写入AOF文件后主动要求系统将缓存内容同步到硬盘中。在 Redis 中我们可以通过 appendfsync 参数设置同步的时机：</p><p class="calibre_9"># appendfsync always</p><p class="calibre_9">appendfsync everysec</p><p class="calibre_9"># appendfsync no</p><p class="calibre_9">默认情况下Redis采用everysec规则，即每秒执行一次同步操作。always表示每次执行写入都会执行同步，这是最安全也是最慢的方式。no表示不主动进行同步操作，而是完全交由操作系统来做（即每30秒一次），这是最快但最不安全的方式。一般情况下使用默认值everysec就足够了，既兼顾了性能又保证了安全。</p><p class="calibre_9">Redis 允许同时开启 AOF 和 RDB，既保证了数据安全又使得进行备份等操作十分容易。此时重新启动Redis后Redis会使用AOF文件来恢复数据，因为AOF方式的持久化可能丢失的数据更少。</p><div class="mbp_pagebreak" id="calibre_pb_39"></div>
</body></html>
