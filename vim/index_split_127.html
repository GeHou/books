<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Vim实用技巧</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos634965" class="calibre_8"><span class="calibre1"><span class="bold">技巧109定制grep程序</span></span></p><p class="calibre_9"> Vim的:grep命令是外部grep程序的包装器。通过配置 ‘grepprg’与‘grepformat’这两个选项，我们可以对 Vim 查找的行为进行定制。首先，我们将检查这两个选项的缺省设置，然后，将会看到如何修改这些设置，从而将查找任务外包给其他合适的程序。 </p><p class="calibre_8"><span class="calibre3"><span class="bold">Vim缺省的grep设置</span></span></p><p class="calibre_9">当我们执行Vim的<span class="bold">:grep</span>命令时，<span class="bold">‘grepprg’</span>选项负责指定所调用的shell程序（参见<span class="bold">:h 'grepprg'</span><img src="images/00243.jpg" class="calibre_10"/>）。而<span class="bold">‘grepformat’</span> 选项则指示Vim如何解析来自<span class="bold">:grep</span>命令的输出结果（参见<span class="bold">:h 'grepformat'</span><img src="images/00243.jpg" class="calibre_10"/>）。在Unix系统中，这些缺省的设置如下所示：</p><p class="calibre_"><img src="images/00095.jpg" class="calibre_282"/></p><p class="calibre_7">其中，出现在<span class="bold">‘grepprg’</span>选项中的符号<span class="bold">$*</span>表示占位符，最终它将被提供给<span class="bold">:grep</span>命令的参数所代替。</p><p class="calibre_7"><span class="bold">‘grepformat’</span>选项由一串字符组成，其内容包括用于解析<span class="bold">:grep</span>执行结果的符号。<span class="bold">‘grepformat’</span>选项中的特殊标识符，与我们在用Nodelint的输出结果填充Ouickfix列表中所见的<span class="bold">‘errorformat’</span>是一样的。要了解完整的列表，请查阅<span class="bold">:h errorformat</span><img src="images/00243.jpg" class="calibre_10"/>。</p><p class="calibre_7">接下来让我们看一看，缺省的 %<span class="bold">f:</span>%<span class="bold">1</span> %<span class="bold">m</span>格式是如何解析来自<span class="bold">grep</span>的输出结果的：</p><p class="calibre_"><img src="images/00109.jpg" class="calibre_283"/></p><p class="calibre_7">对于每一项记录，%<span class="bold">f</span>表示文件名（如本例中的<span class="bold">department-store.txt</span>或者<a class="calibre2"></a><span class="bold">goldrush.txt</span>），%<span class="bold">l</span>表示行号，而 %<span class="bold">m</span>则表示匹配行的文本。</p><p class="calibre_7"><span class="bold">‘grepformat’</span>字符串可以包含以逗号分隔的多组格式。缺省设置也能匹配%<span class="bold">f:</span>%<span class="bold">l</span>%<span class="bold">m</span> 或 %<span class="bold">f</span> %<span class="bold">l</span>%<span class="bold">m</span>，不过Vim将采用第一种格式匹配来自<span class="bold">:grep</span>的输出结果。</p><p class="calibre_8"><span class="calibre3"><span class="bold">通过‘:grep’调用ack</span></span></p><p class="calibre_9"><span class="bold">ack</span>作为可取代<span class="bold">grep</span>的程序，尤其受到程序员的青睐。如果你想了解它与<span class="bold">grep</span>的对比情况，请访问其首页，而且一定要看这个网址<span class="bold">http://betterthangrep.com</span>。</p><p class="calibre_7">首先，我们需要安装<span class="bold">ack</span>。在Ubuntu中，可以通过以下命令完成：</p><p class="calibre_7">➾ <span class="bold">$ sudo apt-get install ack-grep</span></p><p class="calibre_7">➾ <span class="bold">$ sudo ln -s /usr/bin/ack-grep /usr/local/bin/ack</span></p><p class="calibre_7">其中，第一条命令负责安装<span class="bold">ack</span>程序，让我们可以用<span class="bold">ack-grep</span>调用它。第二条命令负责创建符号链接，让我们只需通过<span class="bold">ack</span>即可实现调用。</p><p class="calibre_7">在OS X中，我们可以通过Homebrew进行安装：</p><p class="calibre_8"><span class="bold">➾ $ brew install ack</span></p><p class="calibre_9">让我们看看如何定制<span class="bold">‘grepprg’</span>与<span class="bold">‘grepformat’</span>这两个选项，实现让<span class="bold">:grep</span>调用<span class="bold">ack</span>，而不是缺省的<span class="bold">grep</span>。在缺省情况下，<span class="bold">ack</span>会用单独的一行列出文件名，然后再从下一行起，列出此文件匹配行的行号及内容，如下所示：</p><p class="calibre_8"><span class="bold">➾ $ ack Waldo *</span></p><p class="calibre_8"><span class="calibre8"> 《 department-store.txt</span><br class="calibre4"/><span class="calibre8"> 1:Waldo is beside the boot counter. </span></p><p class="calibre_5"><span class="calibre8"> goldrush.txt</span><br class="calibre4"/><span class="calibre8"> 6:Waldo is studying his clipboard.</span><br class="calibre4"/><span class="calibre8"> 9:The penny farthing is 10 paces ahead of Waldo. </span></p><p class="calibre_7">我们可以方便地改变<span class="bold">ack</span>的输出格式，即通过在运行<span class="bold">ack</span>时加入<span class="bold">-nogroup</span>参数，实现类似<span class="bold">grep -n</span>的效果：</p><p class="calibre_8"><span class="bold">➾ $ ack --nogroup Waldo *</span></p><p class="calibre_8"><span class="calibre8"> 《 department-store.txt:1:Waldo is beside the boot counter.</span><br class="calibre4"/><span class="calibre8"> goldrush.txt:6:Waldo is studying his clipboard. </span></p><p class="calibre_5">
<a class="calibre2"></a>
</p><p class="calibre_5"><span class="calibre8"> goldrush.txt:9:The penny farthing is 10 paces ahead of Waldo. </span></p><p class="calibre_7">事实证明，输出的结果的确与<span class="bold">grep -n</span> 的格式吻合，另外，由于Vim缺省的<span class="bold">‘grepformat’</span>选项已经知道如何去解析这些内容，因此，我们没必要对它进行修改。综上所述，采用<span class="bold">ack</span>代替<span class="bold">grep</span>的最简单方法就是把<span class="bold">‘grepprg’</span>设成以下值：</p><p class="calibre_8"><span class="bold">➾:set grepprg=ack\ --nogroup\ $*</span></p><p class="calibre_8"><span class="calibre3"><span class="bold">通过ack跳转到指定的行与列</span></span></p><p class="calibre_9"><span class="bold">Ack</span>还有另一项绝技。当我们采用<span class="bold">--columm</span>参数运行<span class="bold">ack</span>时，它会给出每一处匹配的行号与列号。实际结果如下所示：</p><p class="calibre_8"><span class="bold">➾ $ ack --nogroup --column Waldo *</span></p><p class="calibre_8"><span class="calibre8"> 《 department-store.txt:1:1:Waldo is beside the boot counter.</span><br class="calibre4"/><span class="calibre8"> goldrush.txt:6:1:Waldo is studying his clipboard.</span><br class="calibre4"/><span class="calibre8"> goldrush.txt:9:41:The penny farthing is 10 paces ahead of Waldo. </span></p><p class="calibre_7">如果我们能够通过修改<span class="bold">‘grepformat’</span>选项，将这项额外的信息提取出来的话，在浏览查找结果时，就可以跳转到每一处匹配的精确位置，而不仅是准确的行。通过以下设置，即可轻松实现这一功能：</p><p class="calibre_8"><span class="bold">➾:set grepprg=ack\ --nogroup\ --column\ $* </span></p><p class="calibre_8"><span class="bold">➾:set grepformat=%f:%l:%c:%m</span></p><p class="calibre_9">其中，符号<span class="bold">%c</span>表示列号。</p><p class="calibre_6">其他grep插件</p><p class="calibre_6"> 对于Vim来说，将跨文件搜索的工作外包给外部程序很容易。只需修改‘grepprg’与‘grepformat’这两项设置并执行:grep即可。这样一来，我们的结果就会顺理成章地出现在quickfix列表中。实际上，不论Vim调用的是哪种程序，其接口基本上是统一的。 </p><p class="calibre_7"> 但程序之间毕竟存在着一些重要的差异。例如，grep采用的是POSIX风格的正则表达式，而ack则采用的是Perl风格的正则表达式。如果 :grep命令在后台调用ack，可能会引起误导。与其这样，你为什么不创建一条名为:Ack的命令，使其名副其实呢？ </p><p class="calibre_5">
<a class="calibre2"></a>
</p><p class="calibre_7"> Ack.vim<sup class="calibre5"><small id="filepos642980" class="calibre6"><a href="index_split_128.html#filepos647431" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(1)</span></span></span></a></small></sup>插件恰好符合以上需求。类似地，fugitive.vim<sup class="calibre5"><small id="filepos643150" class="calibre6"><a href="index_split_128.html#filepos647588" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(2)</span></span></span></a></small></sup>插件也为我们提供了一个名为:Ggrep的自定义命令用于执行git-grep。当然，我们还可以安装几个类似的插件，而且由于每个插件都是创建各自的自定义命令，而不是覆盖:grep命令，因此，它们彼此之间不受影响。我们再也用不着死守着一个grep程序了。 </p><p class="calibre_7"> 我们可以针对当前的任务，选用合适的命令。 </p><div class="mbp_pagebreak" id="calibre_pb_145"></div>
</body></html>
