<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Vim实用技巧</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos620090" class="calibre_8"><span class="calibre1"><span class="bold">技巧107定制外部编译器</span></span></p><p class="calibre_9"> Vim的:make命令不仅限于调用外部的make程序，也可以调用任何安装在你机器上的编译器。（注意，Vim对编译器的定义，比你所熟识的定义更宽松，请参 <a class="calibre2"></a>见‘：<span class="italic">compiler’与‘：make’不仅限于编译型语言</span>。）在本节中，我们将对:make命令进行设置，使其可以调用JSLint来验证JavaScript文件，并根据输出的结果填充quickfix列表。 </p><p class="calibre_7">首先，我们要配置Vim，使其在运行<span class="bold">:make</span>时可以调用nodelint <sup class="calibre5"><small id="filepos620808" class="calibre6"><a href="#filepos629088" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(1)</span></span></span></a></small></sup>，即JSLint<sup class="calibre5"><small id="filepos620933" class="calibre6"><a href="#filepos629242" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(2)</span></span></span></a></small></sup>的命令行接口。nodelint依赖Node.js，它可以通过以下简单的NPM命令进行安装：<sup class="calibre5"><small id="filepos621145" class="calibre6"><a href="#filepos629383" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(3)</span></span></span></a></small></sup></p><p class="calibre_8"><span class="bold">➾ $ npm install nodelint -g</span></p><p class="calibre_9">我们将使用FizzBuzz的JavaScript实现版本作为本节的测试用例：</p><p class="calibre_"><img src="images/00205.jpg" class="calibre_280"/></p><p class="calibre_8"><span class="calibre3"><span class="bold">配置‘:make’，使其调用Nodelint</span></span></p><p class="calibre_9"><span class="bold">‘makeprg’</span> 选项允许我们指定运行<span class="bold">:make</span>时所调用的程序（参见<span class="bold">:h 'makeprg'</span><img src="images/00243.jpg" class="calibre_10"/>）。通过以下命令，我们可以指示Vim运行nodelint：</p><p class="calibre_8"><span class="bold">➾:setlocal makeprg=NODE_DISABLE_COLORS=1\ nodelint\ %</span></p><p class="calibre_9">符号%将被扩展成当前文件所在的路径。因此，如果我们正在编辑文件~<span class="bold">/quickfix/fizzbuzz.js</span>，则在Vim中运行<span class="bold">:make</span>等于在shell中运行以下命令：</p><p class="calibre_8"><span class="bold">➾ $ export NODE_DISABLE_COLORS=1</span></p><p class="calibre_8"><span class="bold">➾ $ nodelint ~/quickfix/fizzbuzz.js</span></p><p class="calibre_8"><span class="calibre8"> 《 ~/quickfix/fizzbuzz.js, line 2, character 22: Unexpected '++'.</span><br class="calibre4"/><span class="calibre8"> for (i=1; i &lt;= 100; i++) { </span></p><p class="calibre_5">
<a class="calibre2"></a>
</p><p class="calibre_5"><span class="calibre8"> ~/quickfix/fizzbuzz.js, line 3, character 15: Expected '===' ...</span><br class="calibre4"/><span class="calibre8"> if(i % 15 == 0) {</span><br class="calibre4"/><span class="calibre8"> ~/quickfix/fizzbuzz.js, line 5, character 21: Expected '===' ...</span><br class="calibre4"/><span class="calibre8"> } else if(i % 5 == 0) {</span><br class="calibre4"/><span class="calibre8"> ~/quickfix/fizzbuzz.js, line 7, character 21: Expected '===' ...</span><br class="calibre4"/><span class="calibre8"> } else if(i % 3 == 0) {</span><br class="calibre4"/><span class="calibre8"> ~/quickfix/fizzbuzz.js, line 12, character 2: Unexpected ';'.</span><br class="calibre4"/><span class="calibre8"> };</span><br class="calibre4"/><span class="calibre8"> 5 errors </span></p><p class="calibre_7">在缺省情况下，<span class="bold">nodelint</span>采用ANSI色标编码把错误信息高亮为红色。而配置<span class="bold">NODE_DISABLE_COLORS=1</span>将会禁用颜色高亮，这样一来，就可以更容易地解析出错信息。</p><p class="calibre_7">接下来，我们得让Vim解析nodelint的输出结果，并根据这些结果来构建quickfix列表。解决这个问题的方式有两种：其一，我们可以配置nodelint，使其输出的结果类似于由<span class="bold">make</span>产生的错误信息，这样Vim就可以识别了；或者，由我们来指导Vim如何解析来自nodelint的缺省输出结果。我们将采用第二种技术。</p><p class="calibre_8"><span class="calibre3"><span class="bold">用Nodelint的输出结果填充Quickfix列表</span></span></p><p class="calibre_9"><span class="bold">‘errorformat’</span>选项允许我们指导Vim如何解析由<span class="bold">:make</span>产生的输出结果（参见<span class="bold">:h 'errorformat'</span>
<img src="images/00243.jpg" class="calibre_10"/>）。通过下列命令，我们可以查看该选项的缺省值：</p><p class="calibre_8"><span class="bold">➾:setglobal errorformat?</span></p><p class="calibre_8"><span class="calibre8"> 《 errorformat=%*[^"]"%f"%*\D%l: %m,"%f"%*\D%l: %m, ...[省略]... </span></p><p class="calibre_7">如果你对scanf函数（C语言）比较熟悉的话，那肯定会对即将介绍的概念深有体会。在设置‘errorformat’选项时，每个以百分号开头的字符都有特殊含义。%<span class="bold">f</span>表示文件名，%<span class="bold">l</span>表示行号， %<span class="bold">m</span>表示错误信息。完整的说明列表，请查询<span class="bold">:h errorformat</span><img src="images/00243.jpg" class="calibre_10"/>。</p><p class="calibre_7">为了解析来自nodelint的输出结果，我们可以将错误格式的选项设为如下内容：</p><p class="calibre_8"><span class="bold">➾:setlocal efm=%A%f\,\ line\ %l\,\ character\ %c:%m,%Z%.%#,%-G%.%#</span></p><p class="calibre_9">自此以后，一旦我们再次运行<span class="bold">:make</span>，Vim会采用这种错误格式来解析nodelint的输出结果。对于每一项警告信息，Vim都将提取文件名、行号以及列号，生成一条定位信息，即quickfix列表中的一项记录。这意味着我们可以通过技巧105中所讨论的所有命令，实现在不同警告位置之间的跳转。</p><p class="calibre_5">
<a class="calibre2"></a>
</p><p class="calibre_8"><span class="calibre3"><span class="bold">用一条命令设置‘makeprg’与‘errorformat’</span></span></p><p class="calibre_9">没有人愿意去记<span class="bold">‘errorformat’</span>配置的一大串命令。相反地，我们可以将其保存到某个文件并使用<span class="bold">:compiler</span>命令来激活它。通过这种方式对<span class="bold">‘makeprg’</span>与<span class="bold">‘errorformat’</span>进行配置，既方便又快捷（参见<span class="bold">:h :compiler</span><img src="images/00243.jpg" class="calibre_10"/>）。</p><p class="calibre_8"><span class="bold">➾:compiler nodelint</span></p><p class="calibre_9"><span class="bold">:compiler</span>命令会激活一个编译器插件，它会设置<span class="bold">‘makeprg’</span>与<span class="bold">‘errorformat’</span>选项，使之能够运行并解析nodelint。这一条命令相当于加载了以下多行配置：</p><p class="calibre_"><img src="images/00082.jpg" class="calibre_281"/></p><p class="calibre_7">编译器插件的内部实现更加复杂，但的确物有所值。通过运行以下命令，你可以将Vim自带的编译器插件了解得更透彻。</p><p class="calibre_8"><span class="bold">➾:args $VIMRUNTIME/compiler/*.vim</span></p><p class="calibre_9"> 注意：尽管nodelint编译器插件并没有随同Vim一起发布，但可以方便地进行安装<sup class="calibre5"><small id="filepos627456" class="calibre6"><a href="#filepos629560" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(4)</span></span></span></a></small></sup>。如果我们想一直使用nodelint作为JavaScript文件的编译器，则可以采用自动命令（autocommand）或者文件类型插件加以实现。具体操作的过程，请参见A1.3为特定类型的文件应用个性化设置。 </p><p class="calibre_5">
<a class="calibre2"></a>
</p><p class="calibre_6">‘:compiler’与‘:make’不仅限于编译型语言</p><p class="calibre_6"> 在编译型语言的范畴中，单词make与compile均有其特殊的含义。而在Vim中，相应的:make与:compiler命令却具有更灵活的定义，这使得它们同样适用于解释型语言与标记格式文档（markup formats）。 </p><p class="calibre_7"> 例如，当我们正在编辑某个LaTeX文档时，可以对Vim进行定制，使其在运行:make命令时可将此.tex文件转换成PDF文件。或者，假设我们正在编辑某个解释型语言的源文件，例如JavaScript，也可以配置:make，使其采用JSLint或者其他几种（不那么自以为是的）语法检查器。另外，我们还可以配置:make，使其能够运行测试套件。 </p><p class="calibre_7"> 在Vim的术语中，编译器是指任何可以针对我们的文档进行处理，并生成错误或警告列表的外部程序。而:make命令只负责调用外部编译器，并对其输出进行解析，以此构建一个可供浏览的quickfix列表。 </p><p class="calibre_5">
<a id="filepos629088" class="calibre2"></a><a href="#filepos620808" class="calibre2"><span class="calibre_2"><span class="underline">(1)</span></span></a> https://github.com/tav/nodelint </p><p class="calibre_5">
<a id="filepos629242" class="calibre2"></a><a href="#filepos620933" class="calibre2"><span class="calibre_2"><span class="underline">(2)</span></span></a> http://jslint.com/ </p><p class="calibre_5">
<a id="filepos629383" class="calibre2"></a><a href="#filepos621145" class="calibre2"><span class="calibre_2"><span class="underline">(3)</span></span></a> http://nodejs.org/ 与 http://npmjs.org/, 两个网址 </p><p class="calibre_5">
<a id="filepos629560" class="calibre2"></a><a href="#filepos627456" class="calibre2"><span class="calibre_2"><span class="underline">(4)</span></span></a> https://github.com/bigfish/vim-nodelint </p><div class="mbp_pagebreak" id="calibre_pb_141"></div>
</body></html>
