<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Vim实用技巧</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos140190" class="calibre_8"><span class="calibre1"><span class="bold">技巧28在一行或多个连续行上执行命令</span></span></p><p class="calibre_9">很多 Ex 命令可以用<span class="bold">[range]</span>指定要操作的范围。我们可以用行号、位置标记或是查找模式来指定范围的开始位置及结束位置。</p><p class="calibre_6">Ex命令的优点之一是它们可以在某一范围内的所有行上执行。我们以下面这个简短的HTML文本作为示例：</p><p class="calibre_"><img src="images/00213.jpg" class="calibre_66"/></p><p class="calibre_7">我们将使用<span class="bold">:print</span>命令作为演示。这条命令只是简单地在Vim命令行下方回显指定行的内容，它不产生什么实际影响，不过可以用它来说明一个范围由哪些行构成。当然，你可以试着把以下示例中的<span class="bold">:print</span>换成诸如<span class="bold">:delete</span>、<span class="bold">:join</span>、<span class="bold">:substitute</span> 或<span class="bold">:normal</span>这样的命令，这样就能真切地感受到 Ex 命令是多么有用。</p><p class="calibre_8"><span class="calibre2"><span class="bold">用行号作为地址</span></span></p><p class="calibre_9">如果输入一条只包含数字的Ex命令，那么 Vim 会把这个数字解析成一个地址，并把光标移动到该数字所指定的行上。例如，运行下面的命令将跳到文件的首行：</p><p class="calibre_5">
<a></a>
</p><p class="calibre_8"><span class="bold">➾:1 </span></p><p class="calibre_8"><span class="bold">➾:print</span></p><p class="calibre_8"><span class="calibre6"> 《 1 &lt;!DOCTYPE html&gt; </span></p><p class="calibre_7">此文件只包含5行内容，如果要跳到文件的末尾，既可以输入<span class="bold">:5</span>，也可以用特殊符号<span class="bold">$</span>：</p><p class="calibre_8"><span class="bold">➾:$</span></p><p class="calibre_8"><span class="bold">➾:p</span></p><p class="calibre_8"><span class="calibre6"> 《 5 &lt;/html&gt; </span></p><p class="calibre_7">我们在这里使用的是<span class="bold">:p</span>，它是<span class="bold">:print</span>命令的简写。实际上，用不着分开执行这两条命令，可以像下面这样把这两条命令合成一条：</p><p class="calibre_8"><span class="bold">➾:3p</span></p><p class="calibre_8"><span class="calibre6"> 《 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt; </span></p><p class="calibre_7">此命令会把光标移到第3行，然后显示该行的内容。记住，这里用<span class="bold">:p</span> 命令的目的只是为了进行讲解。如果你执行的是<span class="bold">:3d</span> 命令，那么只需一条命令就可以跳到第3行并删除此行；而与之等效的普通模式命令，则要先执行<span class="bold">3G</span>，再跟着执行<span class="bold">dd</span>。因此，从这个例子就可以看出，Ex命令执行得要比普通模式命令更快。</p><p class="calibre_8"><span class="calibre2"><span class="bold">用地址指定一个范围</span></span></p><p class="calibre_9">迄今为止，地址只是被当成一个单独的行号，不过我们也可以用它来指定一个范围，如下例所示：</p><p class="calibre_8"><span class="bold">➾:2,5p</span></p><p class="calibre_8"><span class="calibre6"> 《 2 &lt;html&gt;</span><br class="calibre3"/><span class="calibre6"> 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt;</span><br class="calibre3"/><span class="calibre6"> 4 &lt;body&gt;&lt;h1&gt;Practical Vim&lt;/h1&gt;&lt;/body&gt;</span><br class="calibre3"/><span class="calibre6"> 5 &lt;/html&gt; </span></p><p class="calibre_7">此例会打印从第2行到第5行之间的每一行的内容（含第2行及第5行）。注意，运行完这条命令后，光标将停留在第5行。通常，一个范围具有如下的形式：</p><p class="calibre_7"><img src="images/00214.jpg" class="calibre_67"/><br class="calibre3"/></p><p class="calibre_7">需注意的是<span class="bold">{start}</span>和<span class="bold">{end}</span>都是地址。到目前为止，我们已经看到过用行号作为地址，然而很快就会看到也能用查找模式或是位置标记作为地址。</p><p class="calibre_7">符号<span class="bold">.</span>代表当前行的地址。因此，我们可以很容易地写出一个范围，用以代表从当前位置到文件末尾间的所有行：</p><p class="calibre_8"><span class="bold">➾:2</span></p><p class="calibre_8"><span class="bold">➾:.,$p</span></p><p class="calibre_8"><span class="calibre6"> 《 2 &lt;html&gt;</span><br class="calibre3"/><span class="calibre6"> 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt;</span><br class="calibre3"/><span class="calibre6"> 4 &lt;body&gt;&lt;h1&gt;Practical Vim&lt;/h1&gt;&lt;/body&gt;</span><br class="calibre3"/><span class="calibre6"> 5 &lt;/html&gt; </span></p><p class="calibre_7">符号<span class="bold">%</span>也有特殊含义，它代表当前文件中的所有行：</p><p class="calibre_8"><span class="bold">➾:%p</span></p><p class="calibre_8"><span class="calibre6"> 《 1 &lt;!DOCTYPE html&gt;</span><br class="calibre3"/><span class="calibre6"> 2 &lt;html&gt;</span><br class="calibre3"/><span class="calibre6"> 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt;</span><br class="calibre3"/><span class="calibre6"> 4 &lt;body&gt;&lt;h1&gt;Practical Vim&lt;/h1&gt;&lt;/body&gt;</span><br class="calibre3"/><span class="calibre6"> 5 &lt;/html&gt; </span></p><p class="calibre_7">这和运行<span class="bold">:1, $p</span>是等效的。这种简写形式在和<span class="bold">:substitute</span>命令一起使用时非常普遍：</p><p class="calibre_8"><span class="bold">➾:%s/Practical/Pragmatic/</span></p><p class="calibre_9">上述命令让 Vim 把每行内的第一个“Practical”替换为“Pragmatic”，我们将在第14章学习关于此命令的更多内容。</p><p class="calibre_8"><span class="calibre2"><span class="bold">用高亮选区指定范围</span></span></p><p class="calibre_9">我们也可以用高亮选区选定一个范围，而不是用数字指定。如果我们先执行<span class="bold">2G</span>，再跟着执行<span class="bold">VG</span>，就会选中如下一个高亮选区：</p><p class="calibre_"><img src="images/00217.jpg" class="calibre_68"/></p><p class="calibre_7">如果现在按下<span class="bold">:</span>键，命令行上就会预先填充一个范围<span class="bold">:'&lt;,'&gt;</span>。这个范围看起来有点晦涩难懂，不过你可以简单地把它理解为一个代表高亮选区的范围。接下来我们就可以输入一条 Ex 命令，使它在每个被选中的行上执行：</p><p class="calibre_8"><span class="bold">➾:'&lt;,'&gt;p</span></p><p class="calibre_8">
<a></a>
</p><p class="calibre_5"><span class="calibre6"> 《 2 &lt;html&gt;</span><br class="calibre3"/><span class="calibre6"> 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt;</span><br class="calibre3"/><span class="calibre6"> 4 &lt;body&gt;&lt;h1&gt;Practical Vim&lt;/h1&gt;&lt;/body&gt;</span><br class="calibre3"/><span class="calibre6"> 5 &lt;/html&gt; </span></p><p class="calibre_7">如果只是想对文件的部分内容执行<span class="bold">:substitute</span>命令，用这种方式定义范围会很方便。</p><p class="calibre_7">符号<span class="bold">'&lt;</span>是代表高亮选区首行的位置标记，而<span class="bold">'&gt;</span>则代表高亮选区的最后一行（更多关于位置标记的内容，请参见技巧53），这些位置标记即使在退出可视模式后仍然存在。如果你尝试在普通模式下直接运行<span class="bold">:'&lt;,'&gt;p</span>，它会始终回显上一次高亮选区所选中的内容。</p><p class="calibre_8"><span class="calibre2"><span class="bold">用模式指定范围</span></span></p><p class="calibre_9">Vim 也接受以模式作为一条 Ex 命令的地址，如下所示：</p><p class="calibre_8"><span class="bold">➾:/&lt;html&gt;/,/&lt;\/html&gt;/p</span></p><p class="calibre_8"><span class="calibre6"> 《 2 &lt;html&gt;</span><br class="calibre3"/><span class="calibre6"> 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt;</span><br class="calibre3"/><span class="calibre6"> 4 &lt;body&gt;&lt;h1&gt;Practical Vim&lt;/h1&gt;&lt;/body&gt;</span><br class="calibre3"/><span class="calibre6"> 5 &lt;/html&gt; </span></p><p class="calibre_7">这个范围看起来比较复杂，但实际上它符合范围的一般形式<span class="bold">:{start},{end}</span>。在本例中，<span class="bold">{start}</span>地址是模式<span class="bold">/&lt;html&gt;/</span>，而<span class="bold">{end}</span>地址是<span class="bold">/&lt;\/html&gt;/</span>。换句话说，这个范围由<span class="bold">&lt;html&gt;</span>开标签所在的行开始，到对应闭标签所在的行结束。</p><p class="calibre_7">在此例中，用地址<span class="bold">:2,5</span>也可以获得同样的结果，并且这种表示方式更简洁，不过它也更不可靠。用模式指定范围的话，我们的命令总是对整个<span class="bold">&lt;html&gt;&lt;/html&gt;</span>范围进行操作，无论这个范围包含多少行都没问题。</p><p class="calibre_8"><span class="calibre2"><span class="bold">用偏移对地址进行修正</span></span></p><p class="calibre_9">假设我们想对位于<span class="bold">&lt;html&gt;&lt;/html&gt;</span>之间的每一行都运行一条 Ex 命令，但是不想包括<span class="bold">&lt;html&gt;</span>及<span class="bold">&lt;/html&gt;</span>标签所在的行，那么可以为之加上偏移：</p><p class="calibre_8"><span class="bold">➾:/&lt;html&gt;/+1,/&lt;\/html&gt;/-1p</span></p><p class="calibre_8"><span class="calibre6"> 《 3 &lt;head&gt;&lt;title&gt;Practical Vim&lt;/title&gt;&lt;/head&gt;</span><br class="calibre3"/><span class="calibre6"> 4 &lt;body&gt;&lt;h1&gt;Practical Vim&lt;/h1&gt;&lt;/body&gt; </span></p><p class="calibre_7">偏移的一般形式是这样的：</p><p class="calibre_"><img src="images/00222.jpg" class="calibre_69"/></p><p class="calibre_7">如果 n 被省略，那么缺省偏移量为1。<span class="bold">{address}</span>可以是一个行号、一个位置标记，或是一个查找模式。</p><p class="calibre_7">假设我们想对由当前行开始的特定几行执行一条命令，那么可以使用相对于当前行的偏移：</p><p class="calibre_8"><span class="bold">➾:2 </span></p><p class="calibre_8"><span class="bold">➾:.,.+3p</span></p><p class="calibre_9">符号<span class="bold">.</span>代表当前行，所以上例中的<span class="bold">:.,.+3</span> 相当于<span class="bold">:2,5</span>。</p><p class="calibre_8"><span class="calibre2"><span class="bold">结论</span></span></p><p class="calibre_9">定义范围的语法非常灵活，既可以混合搭配行号、位置标记以及查找模式，也可以对它们加以偏移。下表对用来构建 Ex 命令的地址及范围的符号进行了总结：</p><p class="calibre3" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" class="calibre_18"><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20"><span class="bold">  符号  </span>
</td><td colspan="1" rowspan="1" valign="top" class="calibre_20"><span class="bold">  地址  </span>
</td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  1   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  文件的第一行   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  $   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  文件的最后一行   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  0   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  虚拟行，位于文件第一行上方   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  .   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  光标所在行   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  'm   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  包含位置标记m的行   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  '&lt;   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  高亮选区的起始行   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  '&gt;   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  高亮选区的结束行   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  %   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  整个文件（:1,$ 的简写形式）   </td></tr></table><p class="calibre_6">第0行在文件中并不真实存在，但它作为一个地址，在某些特定场景下会很有用处。特别是，在把指定范围内的行复制或移动到文件开头时，可以用它做<span class="bold">:copy {address}</span>及<span class="bold">:move {address}</span>命令的最后一个参数。我们将在接下来两个技巧中看到这两条命令的应用实例。</p><p class="calibre_7">在定义一个<span class="bold">[range]</span>时，它总是代表一系列连续行，不过<span class="bold">:global</span> 命令也可以在一系列非连续行上执行Ex命令，我们将在第15章学习这方面的更多知识。</p><div class="mbp_pagebreak" id="calibre_pb_38"></div>
</body></html>
