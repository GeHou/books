<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Vim实用技巧</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos257388" class="calibre_8"><span class="calibre1"><span class="bold">技巧45以超级用户权限保存文件</span></span></p><p class="calibre_9"> 以超级用户运行 Vim 的情况并不常见，然而有时我们不得不把修改保存到一个需要 sudo 权限的文件中。无需重启 Vim就能实现这一功能，我们可以把这个任务委派给一个以sudo 运行的shell进程来完成。 </p><p class="calibre_7">本节在 GVim 中或许无法工作，当然它更不能在 Windows 上工作。只有在 Unix系统的终端里运行 Vim 时，它才能很好地工作。不过，由于本节所讨论的情景非常普遍，因此即使它有这么多约束，这个技巧仍然值得一提。</p><p class="calibre_7">我们以<span class="bold">/etc/hosts</span>为例进行讲解。此文件属于 root 用户，而我们是以用户名“drew”登录的，因此我们只具有该文件的读权限：</p><p class="calibre_8"><span class="bold">➾ $ ls -al /etc/ | grep hosts</span></p><p class="calibre_8"><span class="calibre6"> 《 -rw-r--r-- 1 root wheel 634 6 Apr 15:59 hosts </span></p><p class="calibre_8"><span class="bold">➾ $ whoami</span></p><p class="calibre_8"><span class="calibre6"> 《 drew </span></p><p class="calibre_7">我们先以用户 drew打开此文件：</p><p class="calibre_8"><span class="bold">➾ $ vim /etc/hosts</span></p><p class="calibre_9">第一件需要注意的事是，如果此时按<span class="bold">&lt;C-g&gt;</span>查看文件状态，会发现 Vim 把此文件标识为<span class="bold">[readonly]</span>（只读）。</p><p class="calibre_7">现在试着做出一个修改，看看会发生什么。我们用<span class="bold">Go</span>命令在文件结尾添加一个空行。此时，Vim 会显示一条信息“W10: Waming : Changing a readonly file。你可以把这条消息当作一个善意的提醒，而非禁令。在提示了此消息后，Vim 依旧会做出修改。</p><p class="calibre_7">Vim 不会阻止我们修改一个只读缓冲区，但它不会让我们以通常的方法把修改保存到磁盘上：</p><p class="calibre_8"><span class="bold">➾ :write</span></p><p class="calibre_8"><span class="calibre6"> 《 E45: 'readonly' option is set (add ! to override) </span></p><p class="calibre_7">让我们按上面的提示所说的，在命令结尾加一个叹号，然后再次执行此命令（可以把这解读为“这次我要强制写只读文件”）：</p><p class="calibre_8"><span class="bold">➾ :write!</span></p><p class="calibre_8"><span class="calibre6"> 《 "/etc/hosts" E212: Can't open file for writing </span></p><p class="calibre_7">现在的问题是，我们没有写<span class="bold">/etc/hosts</span>文件的权限。</p><p class="calibre_7">还记得吗，这个文件是由 root 用户拥有的，而我们现在是以用户 drew 在运行Vim。补救的方法是采用下面这条怪模怪样的命令：</p><p class="calibre_8"><span class="bold">➾ :w !sudo tee % &gt; /dev/null</span></p><p class="calibre_8"><span class="calibre6"> 《 Password:</span><br class="calibre3"/><span class="calibre6"> W12: Warning: File "hosts" has changed and the buffer was</span><br class="calibre3"/><span class="calibre6"> changed in Vim as well</span><br class="calibre3"/><span class="calibre6"> [O]k, (L)oad File, Load (A)ll, (I)gnore All: </span></p><p class="calibre_7">此时，Vim 需要与我们进行两次交互。首先要输入用户 drew的密码（我输的时候请把脸转过去），然后 Vim 会警告我们该文件已被修改了，并显示出一个选项菜单。在这里，我建议按<span class="bold">l</span>键重新将该文件载入缓冲区。</p><p class="calibre_7">这条命令是如何工作的？<span class="bold">:write !{cmd}</span>命令会把缓冲区的内容作为标准输入传给指定的<span class="bold">{cmd}</span>，<span class="bold">{cmd}</span>可以是任何外部程序（参见<span class="bold">:h :write_c</span><img src="images/00243.jpg" class="calibre_10"/>）。虽然Vim 仍然是以用户 drew 运行的，但是我们可以让所调用的外部进程以超级用户权限运行。<a></a>在本例中，<span class="bold">tee</span>程序将以sudo权限运行，也就是说它拥有写<span class="bold">/etc/hosts</span>文件的权限。</p><p class="calibre_7">在 Vim 命令行中，<span class="bold">%</span>符号具有特殊含义。它会展开成当前文件的完整路径（参见<span class="bold">:h :_%</span><img src="images/00243.jpg" class="calibre_10"/>），在本例中会展开为<span class="bold">/etc/hosts</span>。因此，该命令的后半部分可以展开为下面的命令：<span class="bold">tee /etc/hosts &gt; /dev/null</span>。这条命令会把缓冲区的内容当作标准输入，并用它来覆盖<span class="bold">/etc/hosts</span>文件的内容。</p><p class="calibre_7">之后，Vim 会检测到该文件已经被一个外部程序修改。一般情况下这意味着缓冲区中的内容和文件不同步了，这就是为什么 Vim 会提示我们做出选择，是要保留缓冲区中的版本，还是载入磁盘上的版本？然而在本例中，文件与缓冲区的内容刚好是完全一致的。</p><p class="calibre_5">
<a></a>
</p><p class="calibre_6">第三部分更快地移动及跳转</p><p class="calibre_6">动作命令是进行Vim操作的最重要的一些命令。我们不仅可以用它们四处移动光标，还能够用它们与操作符待决模式配合使用，指定一段文本范围并在其上进行操作。在本书的这一部分，我们将结识一些最为有用的动作命令。另外，我们还会学习 Vim 的跳转命令，这些命令让我们可以在文件间快速地跳转。</p><p class="calibre_5">
<a id="filepos263351"></a><a href="index_split_048.html#filepos239545"><span class="calibre_2"><span class="underline">(1)</span></span></a> http: //vimcasts org / episodes / the- edit –command / </p><p class="calibre_5">
<a id="filepos263530"></a><a href="index_split_049.html#filepos242575"><span class="calibre_2"><span class="underline">(2)</span></span></a> https://github.com/tpope/vim-rails </p><p class="calibre_5">
<a id="filepos263687"></a><a href="index_split_050.html#filepos254296"><span class="calibre_2"><span class="underline">(3)</span></span></a> http://vimcasts.org/e/15 </p><p class="calibre_5">
<a id="filepos263834"></a><a href="index_split_050.html#filepos254592"><span class="calibre_2"><span class="underline">(4)</span></span></a> netrw即 across NETwork Read and Write files的缩写。——译者注 </p><div class="mbp_pagebreak" id="calibre_pb_59"></div>
</body></html>
