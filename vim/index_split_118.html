<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Vim实用技巧</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos587326" class="calibre_8"><span class="calibre1"><span class="bold">技巧102配置Vim使用ctags</span></span></p><p class="calibre_9"> 如果我们想在Vim中使用基于ctag的跳转命令，首先，要确保标签文件是最新的，其次，要让Vim知道到哪里去找标签文件。 </p><p class="calibre_8"><span class="calibre3"><span class="bold">告诉Vim标签文件在哪里</span></span></p><p class="calibre_9"><span class="bold">'tags'</span>选项指定了Vim应该到哪里去找标签文件（参见<span class="bold">:h 'tags'</span><img src="images/00243.jpg" class="calibre_10"/>）。当<span class="bold">'tags'</span>选项为 <span class="bold">./</span> 时，Vim将把它替换成当前文件所在的路径。以下命令用于查看缺省的配置：</p><p class="calibre_8"><span class="bold">➾:set tags?</span></p><p class="calibre_8"><span class="calibre8"> 《 tags=./tags,tags </span></p><p class="calibre_7">根据上述配置，Vim会在当前文件所在目录以及工作目录中查找标签文件。在某些情况下，如果Vim已在第一个标签文件中找到了匹配项，就不会在第二个标签文件中继续查找了（更多细节，请参见<span class="bold">:h tags-option</span><img src="images/00243.jpg" class="calibre_10"/>）。根据Vim的缺省配置，我们可以在工程的每一个子目录中都建立一个标签文件，或者为了简单起见，只在工程的根目录中维护一个全局的标签文件即可。</p><p class="calibre_7">如果你经常运行<span class="bold">ctags</span>来确保索引与代码同步的话，每次提交代码时，标签文件也会出现在已修改文件列表中。为了不影响源代码的提交记录，可以把版本控制工具配置成忽略标签文件。</p><p class="calibre_8"><span class="calibre3"><span class="bold">生成标签文件</span></span></p><p class="calibre_9">正如我们在用ctags创建代码库的索引所看到的那样，<span class="bold">ctags</span>可以在系统命令行中执行。但其实不必离开 Vim 也可以重新生成标签文件。</p><p class="calibre_8"><span class="calibre3"><span class="bold">简单的例子：手动执行ctags</span></span></p><p class="calibre_9">通过以下命令，我们可在Vim中直接调用<span class="bold">ctags</span>：</p><p class="calibre_8"><span class="bold">➾:!ctags -R</span></p><p class="calibre_9">该命令将从Vim当前的工作目录开始，遍历其所有的子目录，并为其中的每一个文件建立索引。最终，再把这个标签文件保存到当前工作目录中。</p><p class="calibre_7">假设我们想调整一下命令，加入<span class="bold">--exclude=.git</span>或<span class="bold">--languages=-sql</span>等类似的参数，如果每次手动输入命令的话，势必会很麻烦。通过使用以下映射项，能为我们节省不少时间：</p><p class="calibre_8"><span class="bold">➾:nnoremap &lt;f5&gt; :!ctags -R&lt;CR&gt;</span></p><p class="calibre_9">这样一来，我们只需按<span class="bold">&lt;F5&gt;</span>键就可以完成索引的更新工作，尽管如此，我们仍要定期手动更新这个标签文件。现在，让我们考虑一下如何利用一些方式使得此过程自动执行。</p><p class="calibre_8"><span class="calibre3"><span class="bold">在每次保存文件时自动执行ctags</span></span></p><p class="calibre_9">Vim的自动命令（autocommand）功能允许我们在某个事件发生时调用一条命令，这些事件包括缓冲区的创建、打开或者保存等。因此，我们可以创建一条自动命令，在每次保存文件时自动调用<span class="bold">ctags</span>：</p><p class="calibre_8"><span class="bold">➾:autocmd BufWritePost * call system("ctags -R")</span></p><p class="calibre_9">这样一来，每当我们保存文件的改动时，都会对整个代码库进行更新索引操作。</p><p class="calibre_8"><span class="calibre3"><span class="bold">通过版本控制工具的回调机制自动执行ctags</span></span></p><p class="calibre_9">大多数版本控制工具都支持回调机制，允许我们执行一个脚本来响应代码仓库（repository）的事件。我们可以充分利用这一点，将源代码控制工具配置成每次提交代码改动时，自动为代码仓库更新索引。</p><p class="calibre_7">在Tim Pope的《Effortless Ctags with Git》一文中，他为我们讲解了如何为<span class="bold">post-commit</span>、<span class="bold">post-merge</span>以及<span class="bold">post-checkout</span>等事件建立回调机制<sup class="calibre5"><small id="filepos592021" class="calibre6"><a href="index_split_119.html#filepos600584" class="calibre2"><span class="calibre7"><span class="calibre_2"><span class="underline">(3)</span></span></span></a></small></sup>。该方案的优势在于实现了全局回调功能，通过它，你将不必为系统中的每个代码仓库单独进行配置。</p><p class="calibre_8"><span class="calibre3"><span class="bold">结论</span></span></p><p class="calibre_9">每一种为源代码创建索引的策略都各有利弊。虽然手动更新索引的方式最简单，但要求我们定期更新索引，否则索引就会过时了。</p><p class="calibre_7">第二种策略是，每当缓冲区被保存时，通过自动命令调用<span class="bold">ctags</span>。此法保证了标签文件总是处于最新状态，但由此产生的代价是什么呢？对于规模较小的代码库，运行<span class="bold">ctags</span>所消耗的时间可能察觉不到，但对于规模较大的工程，这段时间足以中断我们的工作流程。另外，对于在编辑器之外发生的任何的文件改动，此项技术也无法被派上用场。</p><p class="calibre_7">最后一种策略是，每当提交代码改动时，自动更新代码库的索引。此法很好地兼顾了前两种方式的优缺点。虽然索引文件可能无法与我们最新开发的代码保持同步，但这些缺陷是可以容忍的。因为，当前正在开发的代码是最不可能被用于标签跳转的。还要牢记一点，标签文件的关键字都是通过查找命令定位的（参见详解标签文件），这样一来，即使关键字涉及到修改，也依然能够保持较强的健壮性。</p><div class="mbp_pagebreak" id="calibre_pb_134"></div>
</body></html>
