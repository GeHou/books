<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Vim实用技巧</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre">
<p id="filepos211524" class="calibre_8"><span class="calibre1"><span class="bold">技巧38管理隐藏缓冲区</span></span></p><p class="calibre_9"> Vim 对被修改过的缓冲区会给予特殊对待，以防未加保存就意外退出。本节将介绍如何隐藏一个被修改过的缓冲区，以及如何在退出 Vim 时处理隐藏缓冲区。 </p><p class="calibre_7">在 shell 中，运行如下命令启动 Vim：</p><p class="calibre_8"><span class="bold">➾ $ cd code/files </span></p><p class="calibre_8"><span class="bold">➾ $ ls</span></p><p class="calibre_8"><span class="calibre8"> 《 a.txt b.txt </span></p><p class="calibre_8"><span class="bold">➾ $ vim *.txt</span></p><p class="calibre_8"><span class="calibre8"> 《 2 files to edit </span></p><p class="calibre_7">首先，我们对<span class="bold">a.txt</span>做点修改，按<span class="bold">Go</span>在缓冲区的结尾增加一个空行。先不要保存修改，让我们查看一下当前的缓冲区列表：</p><p class="calibre_5">
<a class="calibre2"></a>
</p><p class="calibre_8"><span class="bold">➾ :ls</span></p><p class="calibre_8"><span class="calibre8"> 《 1 %a + "a.txt" line 1</span><br class="calibre4"/><span class="calibre8"> 2 "b.txt" line 0 </span></p><p class="calibre_7">缓冲区<span class="bold">a.txt</span>前有一个<span class="bold">+</span>号，表示这个缓冲区被修改过了。如果现在保存文件的话，缓冲区的内容就会被写入磁盘里，而<span class="bold">+</span>号也会消失了。但是我们先不急着保存，而是试着切换一下缓冲区：</p><p class="calibre_8"><span class="bold">➾ :bnext</span></p><p class="calibre_8"><span class="calibre8"> 《 E37: No write since last change (add ! to override) </span></p><p class="calibre_7">此时，Vim 会弹出一条错误信息，说当前缓冲区中有未保存的改动。让我们试一下括号中的建议，在上述命令的结尾加一个叹号：</p><p class="calibre_8"><span class="bold">➾ :bnext! </span></p><p class="calibre_8"><span class="bold">➾ :ls</span></p><p class="calibre_8"><span class="calibre8"> 《 1 #h + "a.txt" line 1</span><br class="calibre4"/><span class="calibre8"> 2 %a "b.txt" line 1 </span></p><p class="calibre_7">叹号会强制 Vim 切换缓冲区，即使当前缓冲区中有未保存的修改，也会继续切换。如果现在再运行<span class="bold">:ls</span>命令，就会发现<span class="bold">b.txt</span>被标记为<span class="bold">a</span>，表示它当前是活动缓冲区（active），而<span class="bold">a.txt</span>则被标记为<span class="bold">h</span>，表示它是一个隐藏缓冲区（hidden）。</p><p class="calibre_8"><span class="calibre3"><span class="bold">在退出时处理隐藏缓冲区</span></span></p><p class="calibre_9">当一个缓冲区被隐藏后，Vim允许我们像往常一样工作。我们可以打开其他缓冲区，对其进行修改、保存等，没有任何不同。也就是说，一直到尝试退出编辑会话前，一切如常。然而，当我们想关闭编辑会话时，Vim 就会提醒我们某个缓冲区中有未保存的修改：</p><p class="calibre_8"><span class="bold">➾ :quit</span></p><p class="calibre_8"><span class="calibre8"> 《 E37: No write since last change (add ! to override)</span><br class="calibre4"/><span class="calibre8"> E162: No write since last change for buffer "a.txt" </span></p><p class="calibre_7">Vim 会把第一个有改动的隐藏缓冲区载入当前窗口，这样我们就可以决定如何处理它。如果要保留修改，可以执行<span class="bold">:write</span>命令把缓冲区保存到文件；如果想摒弃此修改，可以执行<span class="bold">:edit!</span>，重新从磁盘读取此文件，这会用文件的内容覆盖缓冲区中的内容。当缓冲区内容与磁盘文件一致后，我们就可以再次尝试执行<span class="bold">:quit</span>命令了。</p><p class="calibre_7">如果会话里有不止一个被修改过的隐藏缓冲区，那么每次执行<span class="bold">:quit</span>命令时，Vim 都会激活下一个未保存的缓冲区。同样的，我们可以用<span class="bold">:write</span>及 <span class="bold">:edit!</span>来保存或摒弃此修改。当没有其他窗口和隐藏缓冲区时，<span class="bold">:q</span>命令就会关闭 Vim。</p><p class="calibre_7">如果想退出 Vim 而不想对未保存的修改进行检查，可以执行<span class="bold">:qall!</span> 命令；如果想保存所有有改动的缓冲区而无需逐个检查，可以用<span class="bold">:wall</span>命令。表6-1对所有处理隐藏缓冲区的方式进行了总结。</p><blockquote class="calibre_26">
<span class="bold">表6-1 在退出时，处理隐藏缓冲区的方式</span>
</blockquote><p class="calibre4" style="margin:0pt; border:0pt; height:1em"> </p><table valign="top" class="calibre_18"><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20"><span class="bold">  命令  </span>
</td><td colspan="1" rowspan="1" valign="top" class="calibre_20"><span class="bold">  用途  </span>
</td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  :w[rite]   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  把缓冲区内容写入磁盘   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  :e[dit]!   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  把磁盘文件内容读入缓冲区（即回滚所做修改）   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  :qa[ll]!   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  关闭所有窗口，摒弃修改而无需警告   </td></tr><tr valign="top" class="calibre_19"><td colspan="1" rowspan="1" valign="top" class="calibre_20">  :wa[ll]!   </td><td colspan="1" rowspan="1" valign="top" class="calibre_20">  把所有改变的缓冲区写入磁盘   </td></tr></table><p class="calibre_8"><span class="calibre3"><span class="bold">运行‘:argdo’或‘:bufdo’前，启用‘hidden’ 设置</span></span></p><p class="calibre_9">缺省情况下，Vim不会让我们从一个改动过的缓冲区切换到其他缓冲区。不管是用<span class="bold">:next!</span>、<span class="bold">:bnext!</span>、<span class="bold">:cnext!</span>，还是其他类似的命令，如果省略了末尾的叹号，Vim就会弹出一条错误信息“已修改但尚未保存”。在多数情况下这条消息都是一个有用的提醒，但在下面这种场景里它却会带来麻烦。</p><p class="calibre_7">让我们考虑一下<span class="bold">:argdo</span>和<span class="bold">:bufdo</span>命令的执行过程。<span class="bold">:argdo {cmd}</span>命令像下面这样工作：</p><p class="calibre_8"><span class="bold">➾ :first </span></p><p class="calibre_8"><span class="bold">➾ :{cmd} </span></p><p class="calibre_8"><span class="bold">➾ :next </span></p><p class="calibre_8"><span class="bold">➾ :{cmd}</span></p><p class="calibre_8"><span class="calibre8"> 《 etc. </span></p><p class="calibre_7">如果我们选择的<span class="bold">{cmd}</span>修改了第一个缓冲区，那么<span class="bold">:next</span>命令将会失败，因为除非我们对第一项中的修改进行了保存，否则Vim是不会让我们跳到参数列表中的第二项的。这用起来很不方便！</p><p class="calibre_7">如果我们启用了<span class="bold">‘hidden’</span>选项的话（参见<span class="bold">:hhidden</span><img src="images/00243.jpg" class="calibre_10"/>），那么就可以不带末尾的叹号来执行<span class="bold">:next</span>、<span class="bold">:bnext</span>及<span class="bold">:cnext</span>命令（等等）了。如果活动缓冲区的内容发生<a class="calibre2"></a>了变化，Vim 会在离开该缓冲区时自动将其设为隐藏。<span class="bold">‘hidden’</span>设置让我们用一条<span class="bold">:argdo</span>或<span class="bold">:bufdo</span>命令就可以修改一组缓冲区。</p><p class="calibre_7">运行完<span class="bold">:argdo {cmd}</span>后，我们需要保存对每个文件所做出的修改。我们可以先执行<span class="bold">:first</span>，然后再用<span class="bold">:wn</span>逐个保存，用这种方式可以逐一检查每个文件；或者，如果我们相信一切正常，那么就可以运行<span class="bold">:argdo write</span>（或<span class="bold">:wall</span>）来保存所有的缓冲区。</p><div class="mbp_pagebreak" id="calibre_pb_50"></div>
</body></html>
